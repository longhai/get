<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Xem d·ªØ li·ªáu CSV | GamesDB Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<style>
body { background: #f8f9fa; padding: 20px; }
table { font-size: 14px; }
.desc-short { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 500px; display: inline-block; vertical-align: top; }
.desc-full { display: none; white-space: pre-wrap; }
.toggle-btn { color: #0d6efd; cursor: pointer; font-size: 13px; user-select: none; }
</style>
</head>
<body>
<div class="container">
  <h2 class="mb-3">üìä GamesDB CSV Viewer</h2>
  <p class="text-muted">T·ª± ƒë·ªông l·∫•y danh s√°ch file trong <code>/data</code> c·ªßa repo.</p>

  <div class="mb-3">
    <label class="form-label">Ch·ªçn t·ªáp CSV:</label>
    <select id="csvSelect" class="form-select w-auto d-inline-block"></select>
    <button id="loadBtn" class="btn btn-primary ms-2">T·∫£i d·ªØ li·ªáu</button>
  </div>

  <div id="tableContainer" class="table-responsive mt-4"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
const repo = location.pathname.split('/')[1]; // T√™n repo
const owner = location.hostname.split('.')[0]; // username
const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/data`;

async function listCSVFiles() {
  try {
    const res = await fetch(apiUrl);
    const files = await res.json();
    const csvFiles = files.filter(f => f.name.endsWith('.csv'));
    const select = document.getElementById('csvSelect');
    select.innerHTML = csvFiles.map(f => `<option value="${f.download_url}">${f.name}</option>`).join('');
    if (csvFiles.length === 0) select.innerHTML = '<option disabled>Kh√¥ng c√≥ file CSV</option>';
  } catch (err) {
    alert('‚ùå Kh√¥ng th·ªÉ l·∫•y danh s√°ch file CSV.\n' + err);
  }
}

async function loadCSV() {
  const url = document.getElementById('csvSelect').value;
  if (!url) return;
  const container = document.getElementById('tableContainer');
  container.innerHTML = "<p class='text-muted'>‚è≥ ƒêang t·∫£i...</p>";

  const res = await fetch(url);
  const csvText = await res.text();

  Papa.parse(csvText, {
    header: true,
    skipEmptyLines: true,
    complete: results => {
      const data = results.data;
      if (data.length === 0) {
        container.innerHTML = "<p class='text-danger'>File CSV tr·ªëng.</p>";
        return;
      }

      const headers = Object.keys(data[0]);
      let tableHTML = `<table id="csvTable" class="table table-striped table-bordered"><thead><tr>`;
      headers.forEach(h => tableHTML += `<th>${h}</th>`);
      tableHTML += `</tr></thead><tbody>`;

      data.forEach(row => {
        tableHTML += '<tr>';
        headers.forEach(h => {
          let value = row[h] ?? '';
          if (h.toLowerCase() === 'description' && value.length > 100) {
            const short = value.slice(0, 100).replace(/"/g, '&quot;');
            const full = value.replace(/"/g, '&quot;');
            value = `
              <span class="desc-short">${short}...</span>
              <span class="desc-full">${full}</span>
              <span class="toggle-btn ms-1">[Xem th√™m]</span>
            `;
          }
          tableHTML += `<td>${value}</td>`;
        });
        tableHTML += '</tr>';
      });

      tableHTML += '</tbody></table>';
      container.innerHTML = tableHTML;

      const table = new DataTable('#csvTable', {
        pageLength: 20,
        responsive: true,
        order: [],
        language: {
          search: "T√¨m ki·∫øm:",
          lengthMenu: "Hi·ªÉn th·ªã _MENU_ d√≤ng",
          info: "Hi·ªÉn th·ªã _START_ - _END_ / _TOTAL_ d√≤ng",
          paginate: { previous: "Tr∆∞·ªõc", next: "Sau" }
        }
      });

      // Toggle m√¥ t·∫£ d√†i/ng·∫Øn
      container.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          const short = e.target.parentNode.querySelector('.desc-short');
          const full = e.target.parentNode.querySelector('.desc-full');
          const expanded = full.style.display === 'inline';
          full.style.display = expanded ? 'none' : 'inline';
          short.style.display = expanded ? 'inline-block' : 'none';
          e.target.textContent = expanded ? '[Xem th√™m]' : '[·∫®n b·ªõt]';
        });
      });
    }
  });
}

document.getElementById('loadBtn').addEventListener('click', loadCSV);
listCSVFiles();
</script>
</body>
</html>
