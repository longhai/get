<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Data CSV Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff6b6b;
            --light-bg: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            padding-bottom: 2rem;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            margin-bottom: 1.5rem;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .file-card {
            cursor: pointer;
            border-left: 4px solid var(--primary-color);
        }
        
        .file-card:hover, .file-card.active {
            border-left-color: var(--accent-color);
            background-color: #f8f9fa;
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 8px;
        }
        
        thead th {
            position: sticky;
            top: 0;
            background-color: var(--primary-color);
            color: white;
            z-index: 10;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 12px;
            color: #6c757d;
        }
        
        .search-box input {
            padding-left: 40px;
        }
        
        .platform-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .csv-table th {
            cursor: pointer;
            user-select: none;
        }
        
        .csv-table th:hover {
            background-color: rgba(0,0,0,0.1);
        }
        
        .sort-icon {
            margin-left: 5px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-gamepad me-2"></i>Game Data CSV Viewer</h1>
                    <p class="lead mb-0">View and explore your scraped game data from TheGamesDB</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button id="refreshBtn" class="btn btn-light">
                        <i class="fas fa-sync-alt me-1"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>CSV Files</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="fileList" class="list-group list-group-flush">
                            <!-- File list will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>File Info</h5>
                    </div>
                    <div class="card-body">
                        <div id="fileInfo">
                            <p class="text-muted mb-0">Select a file to view information</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="tableTitle"><i class="fas fa-table me-2"></i>Select a CSV File</h5>
                        <div id="tableControls" class="d-none">
                            <div class="input-group search-box" style="width: 250px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchInput" class="form-control" placeholder="Search...">
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="loading-spinner" id="loadingSpinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading CSV data...</p>
                        </div>
                        
                        <div id="noDataMessage" class="d-none text-center py-5">
                            <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                            <h4>No Data Available</h4>
                            <p class="text-muted">Select a CSV file from the list to view its contents</p>
                        </div>
                        
                        <div id="tableContainer" class="table-container d-none">
                            <table class="table table-striped table-hover csv-table mb-0">
                                <thead>
                                    <!-- Table headers will be populated here -->
                                </thead>
                                <tbody>
                                    <!-- Table rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="card-footer d-flex justify-content-between align-items-center d-none" id="paginationContainer">
                            <div id="paginationInfo" class="text-muted">
                                <!-- Pagination info will be populated here -->
                            </div>
                            <nav>
                                <ul class="pagination mb-0" id="pagination">
                                    <!-- Pagination controls will be populated here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            dataDir: 'data',
            itemsPerPage: 20
        };

        // Global state
        let currentFile = null;
        let currentData = [];
        let filteredData = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentPage = 1;

        // DOM elements
        const fileListEl = document.getElementById('fileList');
        const fileInfoEl = document.getElementById('fileInfo');
        const tableTitleEl = document.getElementById('tableTitle');
        const tableControlsEl = document.getElementById('tableControls');
        const loadingSpinnerEl = document.getElementById('loadingSpinner');
        const noDataMessageEl = document.getElementById('noDataMessage');
        const tableContainerEl = document.getElementById('tableContainer');
        const paginationContainerEl = document.getElementById('paginationContainer');
        const tableHeadEl = document.querySelector('.csv-table thead');
        const tableBodyEl = document.querySelector('.csv-table tbody');
        const searchInputEl = document.getElementById('searchInput');
        const paginationInfoEl = document.getElementById('paginationInfo');
        const paginationEl = document.getElementById('pagination');
        const refreshBtnEl = document.getElementById('refreshBtn');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadCSVFiles();
            setupEventListeners();
        });

        // Set up event listeners
        function setupEventListeners() {
            searchInputEl.addEventListener('input', handleSearch);
            refreshBtnEl.addEventListener('click', loadCSVFiles);
        }

        // Load CSV files from the data directory
        async function loadCSVFiles() {
            try {
                showLoading(true);
                fileListEl.innerHTML = '<div class="p-3 text-center"><div class="spinner-border spinner-border-sm me-2"></div>Scanning data directory...</div>';
                
                // Get list of CSV files from the data directory
                const files = await scanDataDirectory();
                renderFileList(files);
                showLoading(false);
                
                // If we have files, select the first one
                if (files.length > 0) {
                    selectFile(files[0]);
                } else {
                    showNoDataMessage('No CSV files found in data directory');
                }
                
            } catch (error) {
                console.error('Error loading CSV files:', error);
                fileListEl.innerHTML = '<div class="p-3 text-danger text-center"><i class="fas fa-exclamation-triangle me-2"></i>Error scanning directory</div>';
                showLoading(false);
            }
        }

        // Scan the data directory for CSV files
        async function scanDataDirectory() {
            try {
                // Try to fetch the directory listing
                const response = await fetch(CONFIG.dataDir + '/');
                if (!response.ok) {
                    throw new Error('Cannot access data directory');
                }
                
                const text = await response.text();
                const files = [];
                
                // Parse the directory listing (simple approach for GitHub Pages)
                // This works if directory listing is enabled
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = doc.querySelectorAll('a[href$=".csv"]');
                
                links.forEach(link => {
                    const fileName = link.getAttribute('href');
                    if (fileName && fileName.endsWith('.csv')) {
                        files.push({
                            name: fileName,
                            path: CONFIG.dataDir + '/' + fileName
                        });
                    }
                });
                
                return files;
                
            } catch (error) {
                console.error('Error scanning directory:', error);
                
                // Fallback: try to get known files
                return tryKnownFiles();
            }
        }

        // Fallback: try to access known CSV files
        async function tryKnownFiles() {
            const knownFiles = [
                'NES.csv',
                'Super Nintendo.csv', 
                'Nintendo 64.csv',
                'Game Boy.csv',
                'Sega Genesis.csv',
                'PlayStation.csv'
            ];
            
            const availableFiles = [];
            
            for (const fileName of knownFiles) {
                try {
                    const response = await fetch(`${CONFIG.dataDir}/${fileName}`);
                    if (response.ok) {
                        availableFiles.push({
                            name: fileName,
                            path: CONFIG.dataDir + '/' + fileName
                        });
                    }
                } catch (e) {
                    // Skip files that don't exist
                }
            }
            
            return availableFiles;
        }

        // Render the file list
        function renderFileList(files) {
            if (files.length === 0) {
                fileListEl.innerHTML = '<div class="p-3 text-center text-muted">No CSV files found</div>';
                return;
            }
            
            fileListEl.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = `list-group-item list-group-item-action file-card`;
                fileItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <h6 class="mb-0 platform-name">${file.name.replace('.csv', '')}</h6>
                        <small class="text-muted">CSV</small>
                    </div>
                    <small class="text-muted">${file.name}</small>
                `;
                
                fileItem.addEventListener('click', () => selectFile(file));
                fileListEl.appendChild(fileItem);
            });
        }

        // Select a file and load its data
        async function selectFile(file) {
            currentFile = file;
            currentPage = 1;
            sortColumn = null;
            sortDirection = 'asc';
            searchInputEl.value = '';
            
            // Update UI
            document.querySelectorAll('.file-card').forEach(card => {
                card.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            tableTitleEl.innerHTML = `<i class="fas fa-table me-2"></i>${file.name.replace('.csv', '')}`;
            tableControlsEl.classList.remove('d-none');
            
            showLoading(true);
            noDataMessageEl.classList.add('d-none');
            tableContainerEl.classList.add('d-none');
            paginationContainerEl.classList.add('d-none');
            
            try {
                // Fetch and parse the CSV file
                const csvData = await fetchCSVFile(file.path);
                currentData = csvData;
                filteredData = [...csvData];
                
                if (csvData.length > 0) {
                    renderTableHeaders();
                    renderTableBody();
                    updatePagination();
                    updateFileInfo();
                    
                    showLoading(false);
                    tableContainerEl.classList.remove('d-none');
                    paginationContainerEl.classList.remove('d-none');
                } else {
                    showNoDataMessage('CSV file is empty');
                }
                
            } catch (error) {
                console.error('Error loading CSV data:', error);
                showLoading(false);
                showNoDataMessage(`Error loading file: ${error.message}`);
            }
        }

        // Fetch and parse CSV file
        async function fetchCSVFile(filePath) {
            const response = await fetch(filePath);
            if (!response.ok) {
                throw new Error(`Failed to load file: ${response.status}`);
            }
            
            const csvText = await response.text();
            return parseCSV(csvText);
        }

        // Parse CSV text to JSON
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            
            const headers = parseCSVLine(lines[0]);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        // Parse a CSV line considering quoted fields
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current.trim().replace(/^"|"$/g, ''));
            return values;
        }

        // Render table headers
        function renderTableHeaders() {
            if (currentData.length === 0) return;
            
            const headers = Object.keys(currentData[0]);
            tableHeadEl.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = formatHeader(header);
                th.setAttribute('data-column', header);
                
                if (sortColumn === header) {
                    th.innerHTML += ` <i class="fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} sort-icon"></i>`;
                } else {
                    th.innerHTML += ` <i class="fas fa-sort sort-icon" style="opacity: 0.3;"></i>`;
                }
                
                th.addEventListener('click', () => sortTable(header));
                headerRow.appendChild(th);
            });
            
            tableHeadEl.appendChild(headerRow);
        }

        // Render table body
        function renderTableBody() {
            if (filteredData.length === 0) {
                tableBodyEl.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-muted">No data matches your search</td></tr>';
                return;
            }
            
            const startIndex = (currentPage - 1) * CONFIG.itemsPerPage;
            const endIndex = Math.min(startIndex + CONFIG.itemsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            tableBodyEl.innerHTML = '';
            
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    // Truncate very long values
                    const displayValue = String(value || '').length > 100 
                        ? String(value).substring(0, 100) + '...' 
                        : value || '-';
                    td.textContent = displayValue;
                    td.title = value || ''; // Show full value on hover
                    tr.appendChild(td);
                });
                tableBodyEl.appendChild(tr);
            });
        }

        // Update pagination controls
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / CONFIG.itemsPerPage);
            
            // Update pagination info
            const startItem = (currentPage - 1) * CONFIG.itemsPerPage + 1;
            const endItem = Math.min(currentPage * CONFIG.itemsPerPage, filteredData.length);
            paginationInfoEl.textContent = `Showing ${startItem}-${endItem} of ${filteredData.length} records`;
            
            // Update pagination controls
            paginationEl.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#"><span aria-hidden="true">&laquo;</span></a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    renderTableBody();
                    updatePagination();
                }
            });
            paginationEl.appendChild(prevLi);
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    renderTableBody();
                    updatePagination();
                });
                paginationEl.appendChild(pageLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#"><span aria-hidden="true">&raquo;</span></a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTableBody();
                    updatePagination();
                }
            });
            paginationEl.appendChild(nextLi);
        }

        // Update file information
        function updateFileInfo() {
            if (!currentFile || currentData.length === 0) {
                fileInfoEl.innerHTML = '<p class="text-muted mb-0">Select a file to view information</p>';
                return;
            }
            
            const totalRecords = currentData.length;
            const columns = Object.keys(currentData[0]);
            
            fileInfoEl.innerHTML = `
                <div class="mb-2">
                    <strong>File:</strong> ${currentFile.name}
                </div>
                <div class="mb-2">
                    <strong>Records:</strong> ${totalRecords.toLocaleString()}
                </div>
                <div class="mb-2">
                    <strong>Columns:</strong> ${columns.length}
                </div>
                <div>
                    <strong>Columns:</strong>
                    <small class="d-block mt-1">${columns.join(', ')}</small>
                </div>
            `;
        }

        // Handle search input
        function handleSearch() {
            const searchTerm = searchInputEl.value.toLowerCase();
            
            if (searchTerm === '') {
                filteredData = [...currentData];
            } else {
                filteredData = currentData.filter(row => {
                    return Object.values(row).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            currentPage = 1;
            renderTableBody();
            updatePagination();
        }

        // Sort table by column
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderTableHeaders();
            renderTableBody();
        }

        // Utility functions
        function formatHeader(header) {
            return header.split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function showLoading(show) {
            loadingSpinnerEl.style.display = show ? 'block' : 'none';
        }

        function showNoDataMessage(message) {
            noDataMessageEl.innerHTML = `
                <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                <h4>${message}</h4>
            `;
            noDataMessageEl.classList.remove('d-none');
        }
    </script>
</body>
</html>
