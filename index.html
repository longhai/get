<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CSV Viewer</title>
<style>
  body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
  h1 { text-align: center; }
  select, table { width: 100%; margin-top: 10px; }
  select { padding: 8px; font-size: 16px; }
  table { border-collapse: collapse; background: white; margin-top: 15px; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
  th { background: #333; color: white; position: sticky; top: 0; }
  tr:nth-child(even) { background: #f9f9f9; }
  #status { margin-top: 10px; font-style: italic; color: #555; }
</style>
</head>
<body>
  <h1>üìä Xem d·ªØ li·ªáu CSV trong th∆∞ m·ª•c /data</h1>
  <select id="fileSelect"></select>
  <div id="status"></div>
  <table id="csvTable"></table>

<script>
// H√†m load danh s√°ch file CSV trong th∆∞ m·ª•c /data
async function loadCSVList() {
  try {
    // D√πng GitHub Pages / local environment ‚Üí c·∫ßn c√≥ li·ªát k√™ file
    // Tr∆∞·ªùng h·ª£p ch·∫°y local: ta gi·∫£ ƒë·ªãnh c√≥ file index.json ho·∫∑c ƒë·ªçc qua API repo
    // ƒê∆°n gi·∫£n: n·∫øu ch·∫°y local, ta fetch danh s√°ch qua m·ªôt request t·ªõi GitHub (n·∫øu public)
    const response = await fetch('data/');
    const text = await response.text();
    // Parse danh s√°ch file CSV t·ª´ directory listing HTML
    const files = [...text.matchAll(/href="([^"]+\.csv)"/g)].map(m => m[1]);

    const select = document.getElementById('fileSelect');
    if (files.length === 0) {
      select.innerHTML = `<option>Kh√¥ng t√¨m th·∫•y file CSV n√†o</option>`;
      return;
    }
    select.innerHTML = files.map(f => `<option value="data/${f}">${f}</option>`).join('');
    select.onchange = () => loadCSV(select.value);
    loadCSV(select.value); // T·ª± load file ƒë·∫ßu ti√™n
  } catch (err) {
    document.getElementById('status').textContent = "‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y danh s√°ch file CSV (c√≥ th·ªÉ do h·∫°n ch·∫ø CORS).";
  }
}

// H√†m ƒë·ªçc file CSV v√† hi·ªÉn th·ªã
async function loadCSV(path) {
  const status = document.getElementById('status');
  const table = document.getElementById('csvTable');
  table.innerHTML = "";
  status.textContent = "‚è≥ ƒêang t·∫£i " + path + "...";

  try {
    const res = await fetch(path);
    const csvText = await res.text();
    const rows = csvText.split(/\r?\n/).filter(r => r.trim() !== "");
    if (rows.length === 0) {
      status.textContent = "‚ö†Ô∏è File r·ªóng.";
      return;
    }

    const headers = parseCSVLine(rows[0]);
    const html = [
      "<thead><tr>" + headers.map(h => `<th>${escapeHTML(h)}</th>`).join("") + "</tr></thead>",
      "<tbody>" +
        rows.slice(1).map(row => {
          const cols = parseCSVLine(row);
          return "<tr>" + headers.map((_, i) => `<td>${escapeHTML(cols[i] || "")}</td>`).join("") + "</tr>";
        }).join("") +
      "</tbody>"
    ].join("");

    table.innerHTML = html;
    status.textContent = `‚úÖ Hi·ªÉn th·ªã ${rows.length - 1} d√≤ng t·ª´ ${path}`;
  } catch (err) {
    status.textContent = "‚ùå L·ªói t·∫£i file: " + err.message;
  }
}

// H√†m t√°ch CSV (c√≥ h·ªó tr·ª£ d·∫•u ngo·∫∑c k√©p)
function parseCSVLine(line) {
  const result = [];
  let current = '', insideQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') {
      if (insideQuotes && line[i + 1] === '"') {
        current += '"';
        i++;
      } else {
        insideQuotes = !insideQuotes;
      }
    } else if (c === ',' && !insideQuotes) {
      result.push(current);
      current = '';
    } else {
      current += c;
    }
  }
  result.push(current);
  return result;
}

// Ch·ªëng XSS
function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

loadCSVList();
</script>
</body>
</html>
